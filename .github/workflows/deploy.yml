name: Test Deploy Laravel to Hostinger

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout code
      - name: Checkout code
        uses: actions/checkout@v3

      # 2️⃣ Create ZIP of project (excluding .git folder)
      - name: Create ZIP
        run: zip -r deploy.zip . -x "*.git*"

      # 3️⃣ Upload ZIP to Hostinger
      - name: Upload to Hostinger
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          port: ${{ secrets.PORT }}
          key: ${{ secrets.KEY }}
          source: "deploy.zip"
          target: ${{ secrets.TARGET }}

      # 4️⃣ SSH into server, extract ZIP, create log & verify
      - name: Extract ZIP and log deployment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          port: ${{ secrets.PORT }}
          key: ${{ secrets.KEY }}
          script: |
            cd ${{ secrets.TARGET }}
            echo "==== Deployment Started at $(date) ====" >> deploy.log
            echo "Files before deployment:" >> deploy.log
            ls -la >> deploy.log
            unzip -o deploy.zip
            rm deploy.zip
            echo "Files after deployment:" >> deploy.log
            ls -la >> deploy.log
            echo "==== Deployment Finished at $(date) ====" >> deploy.log

            # ✅ Optional: Verify key file exists
            if [ -f "resources/views/home/home.blade.php" ]; then
              echo "✔ Key file exists" >> deploy.log
            else
              echo "❌ Key file missing!" >> deploy.log
            fi
