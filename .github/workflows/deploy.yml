name: Test Deploy Laravel to Hostinger

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout code
      - name: Checkout code
        uses: actions/checkout@v3

      # 2️⃣ Install rsync (in case runner doesn't have it)
      - name: Install rsync
        run: sudo apt-get update && sudo apt-get install -y rsync

      # 3️⃣ Deploy via rsync (mirror local repo to server)
      - name: Rsync Deploy to Hostinger
        run: |
          rsync -avz --delete \
          --exclude='.git' \
          --exclude='.env' \
          --exclude='deploy.log' \
          ./ ${{ secrets.USER }}@${{ secrets.HOST }}:${{ secrets.TARGET }} -e "ssh -p ${{ secrets.PORT }}"

      # 4️⃣ SSH into server, run Laravel optimizations, log deployment
      - name: SSH Laravel Optimize & Log
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          port: ${{ secrets.PORT }}
          key: ${{ secrets.KEY }}
          script: |
            cd ${{ secrets.TARGET }}
            echo "==== Deployment Started at $(date) ====" >> deploy.log
            php artisan config:clear
            php artisan cache:clear
            php artisan route:clear
            php artisan view:clear
            php artisan optimize
            echo "==== Deployment Finished at $(date) ====" >> deploy.log
