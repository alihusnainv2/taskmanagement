name: Deploy Laravel to Hostinger (ZIP Clean + Composer Install)

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2️⃣ Create ZIP (EXCLUDING .git and .env)
      - name: Create deploy.zip
        run: zip -r deploy.zip . -x "*.git*" -x ".env" -x "*.env.*" -x "vendor/*"

      # 3️⃣ Upload ZIP
      - name: Upload deploy.zip to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          port: ${{ secrets.PORT }}
          key: ${{ secrets.KEY }}
          source: "deploy.zip"
          target: ${{ secrets.TARGET }}

      # 4️⃣ Deploy on server
      - name: Deploy on server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          port: ${{ secrets.PORT }}
          key: ${{ secrets.KEY }}
          script: |
            cd ${{ secrets.TARGET }}

            echo "===== Starting Clean Deployment $(date) =====" >> deploy.log

            echo "Cleaning old files..." >> deploy.log

            # ❌ DELETE EVERYTHING EXCEPT these files
            find . -mindepth 1 \
              ! -name ".env" \
              ! -name ".htaccess" \
              ! -name "index.php" \
              ! -name "server.php" \
              ! -name "deploy.zip" \
              -exec rm -rf {} +

            echo "Extracting ZIP..." >> deploy.log
            unzip -o deploy.zip
            rm deploy.zip

            echo "Running Composer Install..." >> deploy.log
            composer install --no-dev --prefer-dist --optimize-autoloader

            echo "Running Laravel optimize..." >> deploy.log
            php artisan optimize || true

            echo "===== Deployment Completed $(date) =====" >> deploy.log
